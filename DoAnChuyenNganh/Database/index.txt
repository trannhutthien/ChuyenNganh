-- ==============================
-- TẠO DATABASE (không có dữ liệu mẫu)
-- ==============================
DROP DATABASE IF EXISTS Elearning_KyNangCNTT;
CREATE DATABASE Elearning_KyNangCNTT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE Elearning_KyNangCNTT;

-- ==============================
-- 1) NGƯỜI DÙNG & VAI TRÒ
-- ==============================
CREATE TABLE VaiTro (
    VaiTroId INT AUTO_INCREMENT PRIMARY KEY,
    MaVaiTro VARCHAR(50) UNIQUE NOT NULL,   -- ADMIN / STUDENT / EDITOR
    TenVaiTro NVARCHAR(100) NOT NULL,
    MoTa NVARCHAR(255)
);

CREATE TABLE NguoiDung (
    NguoiDungId INT AUTO_INCREMENT PRIMARY KEY,
    Email VARCHAR(255) UNIQUE NOT NULL,
    MatKhauHash VARCHAR(255) NOT NULL,
    HoTen NVARCHAR(150) NOT NULL,
    AvatarUrl NVARCHAR(300),
    TrangThai TINYINT DEFAULT 1, -- 1=active, 0=locked (tuỳ bạn dùng)
    TaoLuc DATETIME DEFAULT CURRENT_TIMESTAMP,
    CapNhatLuc DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE NguoiDung_VaiTro (
    NguoiDungId INT NOT NULL,
    VaiTroId INT NOT NULL,
    PRIMARY KEY (NguoiDungId, VaiTroId),
    FOREIGN KEY (NguoiDungId) REFERENCES NguoiDung(NguoiDungId) ON DELETE CASCADE,
    FOREIGN KEY (VaiTroId) REFERENCES VaiTro(VaiTroId) ON DELETE CASCADE
);

-- ==============================
-- 2) KỸ NĂNG — KHÓA HỌC (N–N)
-- ==============================
CREATE TABLE KyNang (
    KyNangId INT AUTO_INCREMENT PRIMARY KEY,
    TenKyNang NVARCHAR(150) UNIQUE NOT NULL,
    MoTa NVARCHAR(500),
    CapDo TINYINT DEFAULT 1 CHECK (CapDo BETWEEN 1 AND 3)
);

CREATE TABLE KhoaHoc (
    KhoaHocId INT AUTO_INCREMENT PRIMARY KEY,
    TieuDe NVARCHAR(200) NOT NULL,
    HinhAnhUrl NVARCHAR(300),                    -- ảnh đại diện khóa học
    TomTat NVARCHAR(500),
    CapDo TINYINT DEFAULT 1 CHECK (CapDo BETWEEN 1 AND 3),
    Tags NVARCHAR(300),
    DieuKienTienQuyet NVARCHAR(300),
    GiaTien DECIMAL(10,2) DEFAULT 0,             -- giá khóa học
    TrangThai TINYINT DEFAULT 2 CHECK (TrangThai IN (1,2,3)), -- 1=draft,2=published,3=archived
    TaoLuc DATETIME DEFAULT CURRENT_TIMESTAMP,
    CapNhatLuc DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE KyNang_KhoaHoc (
    KyNangId INT NOT NULL,
    KhoaHocId INT NOT NULL,
    PRIMARY KEY (KyNangId, KhoaHocId),
    FOREIGN KEY (KyNangId) REFERENCES KyNang(KyNangId) ON DELETE CASCADE,
    FOREIGN KEY (KhoaHocId) REFERENCES KhoaHoc(KhoaHocId) ON DELETE CASCADE
);

-- ==============================
-- 3) BÀI HỌC — NGÂN HÀNG — CÂU HỎI — LỰA CHỌN
-- ==============================
CREATE TABLE BaiHoc (
    BaiHocId INT AUTO_INCREMENT PRIMARY KEY,
    KhoaHocId INT NOT NULL,
    TieuDe NVARCHAR(200) NOT NULL,
    ThuTu INT DEFAULT 1,
    TrangThai TINYINT DEFAULT 2 CHECK (TrangThai IN (1,2,3)), -- 1=draft,2=published,3=archived
    TaoLuc DATETIME DEFAULT CURRENT_TIMESTAMP,
    CapNhatLuc DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (KhoaHocId) REFERENCES KhoaHoc(KhoaHocId) ON DELETE CASCADE,
    UNIQUE (KhoaHocId, ThuTu)
);

-- ==============================
-- BẢNG NỘI DUNG BÀI HỌC (BLOCK)
-- ==============================
CREATE TABLE NoiDungBaiHoc (
    NoiDungId INT AUTO_INCREMENT PRIMARY KEY,
    BaiHocId INT NOT NULL,

    -- loại nội dung: tiêu đề, tiêu đề nhỏ, đoạn văn, hình ảnh, video, trích dẫn...
    LoaiNoiDung ENUM(
        'heading',
        'subheading',
        'paragraph',
        'image',
        'video',
        'quote',
        'list'
    ) NOT NULL,

    -- nội dung text hoặc URL hoặc JSON tùy loại
    NoiDung TEXT,

    -- thứ tự hiển thị trong bài học
    ThuTu INT DEFAULT 1,

    TaoLuc DATETIME DEFAULT CURRENT_TIMESTAMP,
    CapNhatLuc DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (BaiHocId) REFERENCES BaiHoc(BaiHocId) ON DELETE CASCADE
);

-- Index tối ưu truy vấn
CREATE INDEX IX_NoiDungBaiHoc_BaiHocId ON NoiDungBaiHoc(BaiHocId);
CREATE INDEX IX_NoiDungBaiHoc_ThuTu ON NoiDungBaiHoc(ThuTu);


-- Ngân hàng câu hỏi thuộc KHÓA HỌC
CREATE TABLE NganHangCauHoi (
    NganHangId INT AUTO_INCREMENT PRIMARY KEY,
    KhoaHocId INT NOT NULL,
    TenNganHang NVARCHAR(200) NOT NULL,
    MoTa NVARCHAR(300),
    CapDoMacDinh TINYINT DEFAULT 1 CHECK (CapDoMacDinh BETWEEN 1 AND 3),
    FOREIGN KEY (KhoaHocId) REFERENCES KhoaHoc(KhoaHocId) ON DELETE CASCADE
);

-- Câu hỏi: thuộc Ngân hàng, có thể gắn Bài học (hoặc NULL nếu câu chung)
CREATE TABLE CauHoi (
    CauHoiId INT AUTO_INCREMENT PRIMARY KEY,
    NganHangId INT NOT NULL,
    BaiHocId INT NULL,
    Loai ENUM('MOT_DAP_AN','NHIEU_DAP_AN','DUNG_SAI','DIEN_KHUYET') NOT NULL,
    DeBai TEXT NOT NULL,
    GiaiThich TEXT,
    DoKho TINYINT DEFAULT 1 CHECK (DoKho BETWEEN 1 AND 3),
    ChuDeTags NVARCHAR(300),
    ThuTu INT DEFAULT 1,
    FOREIGN KEY (NganHangId) REFERENCES NganHangCauHoi(NganHangId) ON DELETE CASCADE,
    FOREIGN KEY (BaiHocId) REFERENCES BaiHoc(BaiHocId),
    UNIQUE KEY UX_CauHoi_NganHang_ThuTu (NganHangId, ThuTu) -- thứ tự không trùng trong 1 ngân hàng
);

CREATE TABLE LuaChon (
    LuaChonId INT AUTO_INCREMENT PRIMARY KEY,
    CauHoiId INT NOT NULL,
    NoiDung TEXT NOT NULL,
    DungHaySai BOOLEAN DEFAULT 0,
    ThuTu INT DEFAULT 1,
    FOREIGN KEY (CauHoiId) REFERENCES CauHoi(CauHoiId) ON DELETE CASCADE,
    UNIQUE KEY UX_LuaChon_CauHoi_ThuTu (CauHoiId, ThuTu) -- thứ tự lựa chọn không trùng trong 1 câu
);

-- ==============================
-- 4) BÀI KIỂM TRA — LẦN LÀM — TRẢ LỜI
-- ==============================
CREATE TABLE BaiKiemTra (
    BaiKiemTraId INT AUTO_INCREMENT PRIMARY KEY,
    KhoaHocId INT NULL,
    BaiHocId INT NULL,
    TieuDe NVARCHAR(200) NOT NULL,
    ThietLapJson JSON,
    DiemDat DECIMAL(5,2) DEFAULT 5.00,
    TrangThai TINYINT DEFAULT 2 CHECK (TrangThai IN (1,2,3)), -- 1=draft,2=published,3=archived
    TaoLuc DATETIME DEFAULT CURRENT_TIMESTAMP,
    CapNhatLuc DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (KhoaHocId) REFERENCES KhoaHoc(KhoaHocId) ON DELETE CASCADE,
    FOREIGN KEY (BaiHocId) REFERENCES BaiHoc(BaiHocId) ON DELETE CASCADE
    -- Quy ước nghiệp vụ:
    --  - Quiz cuối bài:  KhoaHocId != NULL, BaiHocId != NULL
    --  - Quiz cấp khóa: KhoaHocId != NULL, BaiHocId IS NULL
);

CREATE TABLE LanLamBai (
    LanLamBaiId INT AUTO_INCREMENT PRIMARY KEY,
    BaiKiemTraId INT NOT NULL,
    NguoiDungId INT NOT NULL,
    BatDauLuc DATETIME DEFAULT CURRENT_TIMESTAMP,
    NopBaiLuc DATETIME,
    DiemSo DECIMAL(5,2),
    ChiTietJson JSON, -- snapshot bộ câu, cấu hình chấm...
    TrangThai ENUM('INPROGRESS','SUBMITTED','CANCELLED') DEFAULT 'INPROGRESS',
    FOREIGN KEY (BaiKiemTraId) REFERENCES BaiKiemTra(BaiKiemTraId) ON DELETE CASCADE,
    FOREIGN KEY (NguoiDungId) REFERENCES NguoiDung(NguoiDungId) ON DELETE CASCADE
);

CREATE TABLE TraLoi (
    TraLoiId INT AUTO_INCREMENT PRIMARY KEY,
    LanLamBaiId INT NOT NULL,
    CauHoiId INT NOT NULL,
    LuaChonIds NVARCHAR(300), -- có thể đổi sang JSON nếu cần
    DungHaySai BOOLEAN,
    ThoiGianGiay INT,
    FOREIGN KEY (LanLamBaiId) REFERENCES LanLamBai(LanLamBaiId) ON DELETE CASCADE,
    FOREIGN KEY (CauHoiId) REFERENCES CauHoi(CauHoiId) ON DELETE CASCADE
);

-- ==============================
-- 5) GHI DANH / TIẾN ĐỘ
-- ==============================
CREATE TABLE GhiDanh (
    NguoiDungId INT NOT NULL,
    KhoaHocId INT NOT NULL,
    PhanTramHoanThanh DECIMAL(5,2) DEFAULT 0.00,
    BaiHocCuoiCungId INT,
    CapNhatLuc DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (NguoiDungId, KhoaHocId),
    FOREIGN KEY (NguoiDungId) REFERENCES NguoiDung(NguoiDungId) ON DELETE CASCADE,
    FOREIGN KEY (KhoaHocId) REFERENCES KhoaHoc(KhoaHocId) ON DELETE CASCADE,
    FOREIGN KEY (BaiHocCuoiCungId) REFERENCES BaiHoc(BaiHocId)
);

-- ==============================
-- 6) INDEX CHO KHÓA NGOẠI (TỐI ƯU TRUY VẤN)
-- ==============================
CREATE INDEX IX_BaiHoc_KhoaHocId ON BaiHoc(KhoaHocId);
CREATE INDEX IX_NganHangCauHoi_KhoaHocId ON NganHangCauHoi(KhoaHocId);
CREATE INDEX IX_CauHoi_NganHangId ON CauHoi(NganHangId);
CREATE INDEX IX_CauHoi_BaiHocId ON CauHoi(BaiHocId);
CREATE INDEX IX_LuaChon_CauHoiId ON LuaChon(CauHoiId);
CREATE INDEX IX_BaiKiemTra_KhoaHocId ON BaiKiemTra(KhoaHocId);
CREATE INDEX IX_BaiKiemTra_BaiHocId ON BaiKiemTra(BaiHocId);
CREATE INDEX IX_LanLamBai_BaiKiemTraId ON LanLamBai(BaiKiemTraId);
CREATE INDEX IX_LanLamBai_NguoiDungId ON LanLamBai(NguoiDungId);
CREATE INDEX IX_TraLoi_LanLamBaiId ON TraLoi(LanLamBaiId);
CREATE INDEX IX_TraLoi_CauHoiId ON TraLoi(CauHoiId);
CREATE INDEX IX_GhiDanh_KhoaHocId ON GhiDanh(KhoaHocId);
