DROP DATABASE IF EXISTS Elearning_KyNangCNTT;
CREATE DATABASE Elearning_KyNangCNTT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE Elearning_KyNangCNTT;
CREATE TABLE NguoiDung (
    NguoiDungId INT AUTO_INCREMENT PRIMARY KEY,
    Email VARCHAR(255) UNIQUE NOT NULL,
    MatKhauHash VARCHAR(255) NOT NULL,
    HoTen NVARCHAR(150) NOT NULL,
    AvatarUrl NVARCHAR(300),
    TrangThai TINYINT DEFAULT 1,
    TaoLuc DATETIME DEFAULT CURRENT_TIMESTAMP,
    CapNhatLuc DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE VaiTro (
    VaiTroId INT AUTO_INCREMENT PRIMARY KEY,
    MaVaiTro VARCHAR(50) UNIQUE NOT NULL,
    TenVaiTro NVARCHAR(100) NOT NULL,
    MoTa NVARCHAR(255)
);

CREATE TABLE NguoiDung_VaiTro (
    NguoiDungId INT NOT NULL,
    VaiTroId INT NOT NULL,
    PRIMARY KEY (NguoiDungId, VaiTroId),
    FOREIGN KEY (NguoiDungId) REFERENCES NguoiDung(NguoiDungId) ON DELETE CASCADE,
    FOREIGN KEY (VaiTroId) REFERENCES VaiTro(VaiTroId) ON DELETE CASCADE
);
CREATE TABLE KyNang (
    KyNangId INT AUTO_INCREMENT PRIMARY KEY,
    TenKyNang NVARCHAR(150) UNIQUE NOT NULL,
    MoTa NVARCHAR(500),
    CapDo TINYINT DEFAULT 1
);
CREATE TABLE personal_access_tokens (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    tokenable_type VARCHAR(255) NOT NULL,
    tokenable_id BIGINT UNSIGNED NOT NULL,
    name VARCHAR(255) NOT NULL,
    token VARCHAR(64) NOT NULL UNIQUE,
    abilities TEXT,
    last_used_at TIMESTAMP NULL,
    expires_at TIMESTAMP NULL,
    created_at TIMESTAMP NULL,
    updated_at TIMESTAMP NULL,
    INDEX personal_access_tokens_tokenable_type_tokenable_id_index (tokenable_type, tokenable_id)
);

CREATE TABLE KhoaHoc (
    KhoaHocId INT AUTO_INCREMENT PRIMARY KEY,
    TieuDe NVARCHAR(200) NOT NULL,
    HinhAnhUrl NVARCHAR(300),
    TomTat NVARCHAR(500),
    CapDo TINYINT DEFAULT 1,
    Tags NVARCHAR(300),
    DieuKienTienQuyet NVARCHAR(300),
    GiaTien DECIMAL(10,2) DEFAULT 0,
    TrangThai TINYINT DEFAULT 2,
    TaoLuc DATETIME DEFAULT CURRENT_TIMESTAMP,
    CapNhatLuc DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE KyNang_KhoaHoc (
    KyNangId INT NOT NULL,
    KhoaHocId INT NOT NULL,
    PRIMARY KEY (KyNangId, KhoaHocId),
    FOREIGN KEY (KyNangId) REFERENCES KyNang(KyNangId) ON DELETE CASCADE,
    FOREIGN KEY (KhoaHocId) REFERENCES KhoaHoc(KhoaHocId) ON DELETE CASCADE
);
CREATE TABLE BaiHoc (
    BaiHocId INT AUTO_INCREMENT PRIMARY KEY,
    KhoaHocId INT NOT NULL,
    TieuDe NVARCHAR(200) NOT NULL,
    ThuTu INT DEFAULT 1,
    TrangThai TINYINT DEFAULT 2,
    TaoLuc DATETIME DEFAULT CURRENT_TIMESTAMP,
    CapNhatLuc DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (KhoaHocId) REFERENCES KhoaHoc(KhoaHocId) ON DELETE CASCADE,
    UNIQUE (KhoaHocId, ThuTu)
);
CREATE TABLE NoiDungBaiHoc (
    NoiDungId INT AUTO_INCREMENT PRIMARY KEY,
    BaiHocId INT NOT NULL,
    LoaiNoiDung ENUM('heading','subheading','paragraph','image','video','quote','list') NOT NULL,
    NoiDung TEXT,
    ThuTu INT DEFAULT 1,
    TaoLuc DATETIME DEFAULT CURRENT_TIMESTAMP,
    CapNhatLuc DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (BaiHocId) REFERENCES BaiHoc(BaiHocId) ON DELETE CASCADE
);

CREATE INDEX IX_NoiDungBaiHoc_BaiHocId ON NoiDungBaiHoc(BaiHocId);
CREATE INDEX IX_NoiDungBaiHoc_ThuTu ON NoiDungBaiHoc(ThuTu);
CREATE TABLE NganHangCauHoi (
    NganHangId INT AUTO_INCREMENT PRIMARY KEY,
    KhoaHocId INT NOT NULL,
    TenNganHang NVARCHAR(200) NOT NULL,
    MoTa NVARCHAR(300),
    CapDoMacDinh TINYINT DEFAULT 1,
    FOREIGN KEY (KhoaHocId) REFERENCES KhoaHoc(KhoaHocId) ON DELETE CASCADE
);

CREATE TABLE CauHoi (
    CauHoiId INT AUTO_INCREMENT PRIMARY KEY,
    NganHangId INT NOT NULL,
    BaiHocId INT NULL,
    Loai ENUM('MOT_DAP_AN','NHIEU_DAP_AN','DUNG_SAI','DIEN_KHUYET') NOT NULL,
    DeBai TEXT NOT NULL,
    GiaiThich TEXT,
    DoKho TINYINT DEFAULT 1,
    ChuDeTags NVARCHAR(300),
    ThuTu INT DEFAULT 1,
    FOREIGN KEY (NganHangId) REFERENCES NganHangCauHoi(NganHangId) ON DELETE CASCADE,
    FOREIGN KEY (BaiHocId) REFERENCES BaiHoc(BaiHocId),
    UNIQUE KEY UX_CauHoi_NganHang_ThuTu (NganHangId, ThuTu)
);

CREATE TABLE LuaChon (
    LuaChonId INT AUTO_INCREMENT PRIMARY KEY,
    CauHoiId INT NOT NULL,
    NoiDung TEXT NOT NULL,
    DungHaySai BOOLEAN DEFAULT 0,
    ThuTu INT DEFAULT 1,
    FOREIGN KEY (CauHoiId) REFERENCES CauHoi(CauHoiId) ON DELETE CASCADE,
    UNIQUE KEY UX_LuaChon_CauHoi_ThuTu (CauHoiId, ThuTu)
);
CREATE TABLE BaiKiemTra (
    BaiKiemTraId INT AUTO_INCREMENT PRIMARY KEY,
    KhoaHocId INT NULL,
    BaiHocId INT NULL,
    TieuDe NVARCHAR(200) NOT NULL,
    ThietLapJson JSON,
    DiemDat DECIMAL(5,2) DEFAULT 5.00,
    TrangThai TINYINT DEFAULT 2,
    TaoLuc DATETIME DEFAULT CURRENT_TIMESTAMP,
    CapNhatLuc DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (KhoaHocId) REFERENCES KhoaHoc(KhoaHocId) ON DELETE CASCADE,
    FOREIGN KEY (BaiHocId) REFERENCES BaiHoc(BaiHocId) ON DELETE CASCADE
);

CREATE TABLE LanLamBai (
    LanLamBaiId INT AUTO_INCREMENT PRIMARY KEY,
    BaiKiemTraId INT NOT NULL,
    NguoiDungId INT NOT NULL,
    BatDauLuc DATETIME DEFAULT CURRENT_TIMESTAMP,
    NopBaiLuc DATETIME,
    DiemSo DECIMAL(5,2),
    ChiTietJson JSON,
    TrangThai ENUM('INPROGRESS','SUBMITTED','CANCELLED') DEFAULT 'INPROGRESS',
    FOREIGN KEY (BaiKiemTraId) REFERENCES BaiKiemTra(BaiKiemTraId) ON DELETE CASCADE,
    FOREIGN KEY (NguoiDungId) REFERENCES NguoiDung(NguoiDungId) ON DELETE CASCADE
);

CREATE TABLE TraLoi (
    TraLoiId INT AUTO_INCREMENT PRIMARY KEY,
    LanLamBaiId INT NOT NULL,
    CauHoiId INT NOT NULL,
    LuaChonIds JSON,
    DungHaySai BOOLEAN,
    ThoiGianGiay INT,
    FOREIGN KEY (LanLamBaiId) REFERENCES LanLamBai(LanLamBaiId) ON DELETE CASCADE,
    FOREIGN KEY (CauHoiId) REFERENCES CauHoi(CauHoiId) ON DELETE CASCADE
);
CREATE TABLE GhiDanh (
    NguoiDungId INT NOT NULL,
    KhoaHocId INT NOT NULL,
    PhanTramHoanThanh DECIMAL(5,2) DEFAULT 0,
    BaiHocCuoiCungId INT,
    CapNhatLuc DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (NguoiDungId, KhoaHocId),
    FOREIGN KEY (NguoiDungId) REFERENCES NguoiDung(NguoiDungId) ON DELETE CASCADE,
    FOREIGN KEY (KhoaHocId) REFERENCES KhoaHoc(KhoaHocId) ON DELETE CASCADE,
    FOREIGN KEY (BaiHocCuoiCungId) REFERENCES BaiHoc(BaiHocId)
);
CREATE INDEX IX_BaiHoc_KhoaHocId ON BaiHoc(KhoaHocId);
CREATE INDEX IX_NganHangCauHoi_KhoaHocId ON NganHangCauHoi(KhoaHocId);
CREATE INDEX IX_CauHoi_NganHangId ON CauHoi(NganHangId);
CREATE INDEX IX_CauHoi_BaiHocId ON CauHoi(BaiHocId);
CREATE INDEX IX_LuaChon_CauHoiId ON LuaChon(CauHoiId);
CREATE INDEX IX_BaiKiemTra_KhoaHocId ON BaiKiemTra(KhoaHocId);
CREATE INDEX IX_BaiKiemTra_BaiHocId ON BaiKiemTra(BaiHocId);
CREATE INDEX IX_LanLamBai_BaiKiemTraId ON LanLamBai(BaiKiemTraId);
CREATE INDEX IX_LanLamBai_NguoiDungId ON LanLamBai(NguoiDungId);
CREATE INDEX IX_TraLoi_LanLamBaiId ON TraLoi(LanLamBaiId);
CREATE INDEX IX_TraLoi_CauHoiId ON TraLoi(CauHoiId);
CREATE INDEX IX_GhiDanh_KhoaHocId ON GhiDanh(KhoaHocId);
